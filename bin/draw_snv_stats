#!/usr/bin/env python
'''
Created on 2013 urr 3

@author: peio
'''
from __future__ import division
import argparse
import os

from bam_crumbs.plot import draw_histogram, draw_scatter
from vcf_crumbs.vcf_stats import (calc_density_per_chrom, get_data_from_vcf,
                                  HET, HOM_ALT, HOM_REF, VcfStats,
    calc_n_bases_in_chrom_with_snp)
from crumbs.statistics import draw_histogram_matlib, IntCounter


def _setup_argparse():
    'It prepares the command line argument parsing.'
    description = 'Filter the snvs in an indexed vcf'
    parser = argparse.ArgumentParser(description=description)
    in_help = 'Indexed vcf file'
    parser.add_argument('input', help=in_help, type=argparse.FileType('rt'))
    parser.add_argument('-r', '--reference_file', type=argparse.FileType('rt'),
                        help="Reference file used to find the snvs",
                        required=True)
    parser.add_argument('-o', '--out_dir', default=os.getcwd(),
                        help='Directory to write all output files')
    parser.add_argument('-q', '--gt_qual_threshold', default=0.0, type=float,
            help='Genotype quelity threshold to take into account a genotype')
    parser.add_argument('-s', '--samples_file', default=None,
                        help='File containing selected samples for statistics')

    return parser


def _parse_args(parser):
    '''It parses the command line and it returns a dict with the arguments.'''
    parsed_args = parser.parse_args()
    args = {}
    args['in_fhand'] = parsed_args.input
    args['out_dir'] = parsed_args.out_dir
    if not os.path.exists(args['out_dir']):
        os.mkdir(os.path.abspath(args['out_dir']))
    args['ref_fhand'] = parsed_args.reference_file
    args['gq'] = parsed_args.gt_qual_threshold
    args['samples_fpath'] = parsed_args.samples_file
    return args


def main():
    parser = _setup_argparse()
    args = _parse_args(parser)
    out_dir = args['out_dir']
    ref_fhand = args['ref_fhand']
    gq_threshold = args['gq']
    if args['samples_fpath'] is None:
        selected_samples = None
    else:
        selected_samples = [line.strip() for line in open(args['samples_fpath'])]
    vcf_stats = VcfStats(args['in_fhand'].name, gq_threshold=gq_threshold,
                         selected_samples=selected_samples)

    #densities
    densities = calc_density_per_chrom(vcf_stats.snps_per_chromosome,
                                       ref_fhand, size=100)
    density_fhand = open(os.path.join(out_dir, 'distrib_snv_per_100_pb.png'),
                         'w')
    kwargs = {'title': 'Distribution of snps per 100 pb',
              'xlabel': 'Snvs per 100 pb', 'ylabel': 'Num. Seqs'}
    draw_histogram(densities.values(), density_fhand, bins=100, **kwargs)

    #mafs
    samples = vcf_stats.samples + ['all']
    for sample in samples:
        maf_fhand = open(os.path.join(out_dir,
                             'distrib_maf_per_snv_{}.png'.format(sample)), 'w')
        sample_maf = vcf_stats.mafs[sample]
        distrib = sample_maf.calculate_distribution(bins=50, min_=50, max_=100)
        draw_histogram_matlib(distrib['counts'], fhand=maf_fhand,
                              bin_edges=distrib['bin_limits'],
                        title='Maf distribution for sample {}'.format(sample),
                              xlabel="maf x 100", ylabel="Num. Snvs")

    # call_scatter
    scatter_fhand = open(os.path.join(out_dir, 'call_scatter.png'), 'w')
    kwargs = {'title': 'Ref/alt allele count scatter',
              'ylabel': 'Alternative allele count',
              'xlabel': 'Reference_allele count', 'xlim': (0, 100),
              'ylim': (0, 100)}
    draw_scatter(vcf_stats.call_data.values(), scatter_fhand, **kwargs)

    # Percentage of genotypes different to reference samples  per
    # called samples in each snp
    variable_gt_fhand = open(os.path.join(out_dir, 'variable_gt_per_snp.png'),
                             'w')
    distrib = vcf_stats.variable_gt_per_snp.calculate_distribution(bins=100,
                                                                   min_=0,
                                                                   max_=100)
    title_per = 'Percentage of genotypes different to reference samples  per '
    title_per += 'called samples  in each snp'
    draw_histogram_matlib(distrib['counts'], fhand=variable_gt_fhand,
                              bin_edges=distrib['bin_limits'], title=title_per,
                              xlabel='percentaje variable', ylabel="Num. Snvs")

    #Heterozigosity per sample histogram
    het_by_sample_fhand = open(os.path.join(out_dir,
                                          'heterozygosity_per_sample.png'),
                             'w')
    heterozygosity_per_sample = []
    for het_by_sample in vcf_stats.het_by_sample.values():
        heterozygosity = het_by_sample['num_het'] * 100 / het_by_sample['num_gt']
        heterozygosity_per_sample.append(heterozygosity)
    heterozygosity_stats = IntCounter(iter(heterozygosity_per_sample))
    distrib = heterozygosity_stats.calculate_distribution(bins=100, min_=0,
                                                                   max_=100)
    title_per = 'Heterozigosity per sample distribution'
    draw_histogram_matlib(distrib['counts'], fhand=het_by_sample_fhand,
                              bin_edges=distrib['bin_limits'], title=title_per,
                              xlabel='Heterozigosity', ylabel="Num. samples")

    #Missing calls percentage per snp histogram
    missing_calls_fhand = open(os.path.join(out_dir,
                                          'missing_calls_per_snp.png'),
                             'w')
    missing_calls_stats = IntCounter(iter(vcf_stats.missing_calls_prc))
    distrib = missing_calls_stats.calculate_distribution(bins=100, min_=0,
                                                         max_=100)
    title_per = 'Missing calls percentage distribution'
    draw_histogram_matlib(distrib['counts'], fhand=missing_calls_fhand,
                              bin_edges=distrib['bin_limits'], title=title_per,
                              xlabel='Missing calls percentage',
                              ylabel="Num. SNPs")

    #Number of SNP per ref_seq histogram
    snps_per_refseq_fhand = open(os.path.join(out_dir,
                                          'snps_per_ref_seq.png'),
                             'w')
    snps_per_refseq = vcf_stats.snps_per_chromosome.values()
    max_ = max(snps_per_refseq)
    min_ = min(snps_per_refseq)
    snps_per_refseq_stats = IntCounter(iter(snps_per_refseq))
    distrib = snps_per_refseq_stats.calculate_distribution(bins=max_,
                                                           min_=min_,
                                                           max_=max_)
    title_per = 'Number of SNPs per reference sequence'
    draw_histogram_matlib(distrib['counts'], fhand=snps_per_refseq_fhand,
                              bin_edges=distrib['bin_limits'], title=title_per,
                              xlabel='Number of SNPs per reference seq',
                              ylabel="Num. reference sequences")

    # histogram of the genotype qualities
    gqs_fhand = open(os.path.join(out_dir, 'gt_qual_hist.png'), 'w')
    distrib = vcf_stats.genotype_qualities.calculate_distribution(bins=100)
    draw_histogram_matlib(distrib['counts'], bin_edges=distrib['bin_limits'],
                          fhand=gqs_fhand,
                          title='Histogram of the genotype qualities x 100',
                          xlabel='genotype Qualities x 100',
                          ylabel='num calls')

    stats_fhand = open(os.path.join(out_dir, 'snv_stats.txt'), 'w')
    stats_fhand.write('Num of hete/homo calls.\n')
    stats_fhand.write('----------------------\n')

    num_hets = len([gq for gq in vcf_stats.call_data[HET]['value']
                                                        if gq >= gq_threshold])
    num_hom_ref = len([gq for gq in vcf_stats.call_data[HOM_REF]['value']
                                                        if gq >= gq_threshold])
    num_hom_alt = len([gq for gq in vcf_stats.call_data[HOM_ALT]['value']
                                                        if gq >= gq_threshold])

    stats_fhand.write('Num hete: {}\n'.format(num_hets))
    stats_fhand.write('Num_hom_ref: {}\n'.format(num_hom_ref))
    stats_fhand.write('Num_hom_alt: {}\n'.format(num_hom_alt))
    stats_fhand.write('\n')
    stats_fhand.write('% of heterozigote genotypes per sample\n')
    stats_fhand.write('--------------------------------------\n')
    for sample in sorted(vcf_stats.het_by_sample.keys()):
        counter = vcf_stats.het_by_sample[sample]
        percentaje_het = counter['num_het'] / counter['num_gt']
        stats_fhand.write('{}\t{:.2%}\n'.format(sample, percentaje_het))
    ref_fhand = open(ref_fhand.name)
    n_bases = calc_n_bases_in_chrom_with_snp(vcf_stats.snps_per_chromosome,
                                             ref_fhand)
    stats_fhand.write('\n----------------------------------------\n')
    stats_fhand.write('Num bases covered by seqs with SNPs: {}'.format(
                                                                    n_bases))

if __name__ == '__main__':
    main()
