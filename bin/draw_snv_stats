#!/usr/bin/env python
'''
Created on 2013 urr 3

@author: peio
'''
from __future__ import division
import argparse
import os

from bam_crumbs.plot import draw_histogram, draw_scatter
from vcf_crumbs.vcf_stats import (calc_density_per_chrom, get_data_from_vcf,
                                  HET, HOM_ALT, HOM_REF)


def _setup_argparse():
    'It prepares the command line argument parsing.'
    description = 'Filter the snvs in an indexed vcf'
    parser = argparse.ArgumentParser(description=description)
    in_help = 'Indexed vcf file'
    parser.add_argument('input', help=in_help, type=argparse.FileType('rt'))
    parser.add_argument('-r', '--reference_file', type=argparse.FileType('rt'),
                        help="Reference file used to find the snvs",
                        required=True)
    parser.add_argument('-o', '--out_dir', default=os.getcwd(),
                        help='Directory to write all output files')
    parser.add_argument('-q', '--gt_qual_threshold', default=0.0, type=float,
            help='Genotype quelity threshold to take into account a genotype')

    return parser


def _parse_args(parser):
    '''It parses the command line and it returns a dict with the arguments.'''
    parsed_args = parser.parse_args()
    args = {}
    args['in_fhand'] = parsed_args.input
    args['out_dir'] = parsed_args.out_dir
    if not os.path.exists(args['out_dir']):
        os.mkdir(os.path.abspath(args['out_dir']))
    args['ref_fhand'] = parsed_args.reference_file
    args['gq'] = parsed_args.gt_qual_threshold
    return args


def main():
    parser = _setup_argparse()
    args = _parse_args(parser)
    out_dir = args['out_dir']
    ref_fhand = args['ref_fhand']
    gq_threshold = args['gq']
    data = get_data_from_vcf(args['in_fhand'].name, gq_threshold=gq_threshold)

    #densities
    densities = calc_density_per_chrom(data['snps_per_chromo'], ref_fhand,
                                       size=100)
    density_fhand = open(os.path.join(out_dir, 'distrib_snv_per_100_pb.png'),
                         'w')
    kwargs = {'title': 'Distribution of snps per 100 pb',
              'xlabel': 'Snvs per 100 pb', 'ylabel': 'Num. Seqs'}
    draw_histogram(densities.values(), density_fhand, bins=100, **kwargs)

    #mafs
    samples = list(data['samples']) + ['all']
    for sample in samples:
        maf_fhand = open(os.path.join(out_dir,
                             'distrib_maf_per_snv_{}.png'.format(sample)), 'w')
        kwargs = {'title': 'Maf distribution for sample {}'.format(sample),
                  'xlim': (0.5, 1), 'xlabel': 'Maf', 'ylabel': 'Num. Snvs'}
        mafs = [maf[sample] for maf in data['maf_per_snp'] if sample in maf]
        draw_histogram(mafs, maf_fhand, bins=20, **kwargs)

    # call_scatter
    scatter_fhand = open(os.path.join(out_dir, 'call_scatter.png'), 'w')
    kwargs = {'title': 'Ref/alt allele count scatter',
              'ylabel': 'Alternative allele count',
              'xlabel': 'Reference_allele count', 'xlim': 0, 'ylim': 0}
    draw_scatter(data['call_data'].values(), scatter_fhand, **kwargs)

    # het % for called sample per snp
    variable_gt_fhand = open(os.path.join(out_dir, 'variable_gt_per_snp.png'),
                             'w')
    kwargs = {'title': 'Percentaje of heterozigote samples  per called samples  in each snp',
              'xlabel': 'percentaje het', 'ylabel': 'num snps'}
    draw_histogram(data['variable_gt_per_snp'], variable_gt_fhand, bins=100,
                   **kwargs)

    # histogram of the genotype qualities
    gqs_fhand = open(os.path.join(out_dir, 'gt_qual_hist.png'), 'w')
    kwargs = {'title': 'Histogram of the genotype qualities',
              'xlabel': 'genotype Qualities', 'ylabel': 'num calls'}
    draw_histogram(data['genotype_qualities'], gqs_fhand, bins=100, **kwargs)

    stats_fhand = open(os.path.join(out_dir, 'snv_stats.txt'), 'w')
    stats_fhand.write('Num of hete/homo calls.')
    stats_fhand.write('----------------------\n')

    num_hets = len([gq for gq in data['call_data'][HET]['value']
                                                        if gq >= gq_threshold])
    num_hom_ref = len([gq for gq in data['call_data'][HOM_REF]['value']
                                                        if gq >= gq_threshold])
    num_hom_alt = len([gq for gq in data['call_data'][HOM_ALT]['value']
                                                        if gq >= gq_threshold])

    stats_fhand.write('Num hete: {}\n'.format(num_hets))
    stats_fhand.write('Num_hom_ref: {}\n'.format(num_hom_ref))
    stats_fhand.write('Num_hom_alt: {}\n'.format(num_hom_alt))
    stats_fhand.write('\n')
    stats_fhand.write('% of heterozigote genotypes per sample\n')
    stats_fhand.write('--------------------------------------\n')
    for sample in sorted(data['het_by_sample'].keys()):
        counter = data['het_by_sample'][sample]
        percentaje_het = counter['num_het'] / counter['num_gt']
        stats_fhand.write('{}\t{:.2%}\n'.format(sample, percentaje_het))

if __name__ == '__main__':
    main()
