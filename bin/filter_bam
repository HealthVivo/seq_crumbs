#!/usr/bin/env python
'''
Created on 2013 urt 18

@author: peio
'''
import argparse
import sys
import subprocess

from bam_crumbs.utils.flag import create_flag, SAM_FLAG_TAGS


def filter_bam(in_fpath, out_fpath, min_mapq=0, required_flag_tags=None,
               filtering_flag_tags=None, regions=None):
    'It filters a BAM file'
    cmd = ['samtools', 'view', '-bh']

    if min_mapq:
        cmd.extend(['-q', str(min_mapq)])

    if required_flag_tags:
        flag = create_flag(required_flag_tags)
        cmd.extend(['-f', str(flag)])

    if filtering_flag_tags:
        flag = create_flag(filtering_flag_tags)
        cmd.extend(['-F', str(flag)])

    cmd.extend(['-o', out_fpath, in_fpath])

    if regions:
        regions = ['{0}:{1}-{2}'.format(*s) for s in regions.segments]
        cmd.extend(regions)

    subprocess.check_call(cmd)


def _setup_argparse():
    'It prepares the command line argument parsing.'
    description = 'Filter bam reads by flag or mapping quality'
    parser = argparse.ArgumentParser(description=description)
    parser.add_argument('input', help="bam file with mapping result",
                       type=argparse.FileType('rt'))

    parser.add_argument('-o', '--bam_output', default='output.bam',
                        help='gff output file', type=argparse.FileType('wt'))
    parser.add_argument('--req_flag', action='append',
                        help='required SAM flag', choices=SAM_FLAG_TAGS)
    parser.add_argument('--filter_flag', action='append',
                        help='filtering SAM flag', choices=SAM_FLAG_TAGS)
    msg = 'Minimum mapq to use the read to count coverage'
    parser.add_argument('-p', '--min_mapq', help=msg, type=int)

    return parser


def _parse_args(parser):
    '''It parses the command line and it returns a dict with the arguments.'''
    parsed_args = parser.parse_args()
    args = {}
    args['bam_fhand'] = parsed_args.input
    args['out_fhand'] = parsed_args.bam_output
    args['required_flags'] = parsed_args.req_flag
    args['filtering_flags'] = parsed_args.filter_flag
    args['min_mapq'] = parsed_args.min_mapq

    return args


def main():
    'the main part'
    parser = _setup_argparse()
    args = _parse_args(parser)

    filter_bam(in_fpath=args['bam_fhand'].name,
               out_fpath=args['out_fhand'].name,
               min_mapq=args['min_mapq'],
               required_flag_tags=args['required_flags'],
               filtering_flag_tags=args['filtering_flags'],
               regions=None)


if __name__ == '__main__':
    if len(sys.argv) == 1:
        sys.argv.append('-h')
    main()
